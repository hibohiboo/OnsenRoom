<?php
$dmg_rate_array=array();
$dmg_rate_array[0]=array( '*','0','0','0','1','2','2','3','3','4','4');
$dmg_rate_array[1]=array( '*','0','0','0','1','2','3','3','3','4','4');
$dmg_rate_array[2]=array( '*','0','0','0','1','2','3','4','4','4','4');
$dmg_rate_array[3]=array( '*','0','0','1','1','2','3','4','4','4','5');
$dmg_rate_array[4]=array( '*','0','0','1','2','2','3','4','4','5','5');
$dmg_rate_array[5]=array( '*','0','1','1','2','2','3','4','5','5','5');
$dmg_rate_array[6]=array( '*','0','1','1','2','3','3','4','5','5','5');
$dmg_rate_array[7]=array( '*','0','1','1','2','3','4','4','5','5','6');
$dmg_rate_array[8]=array( '*','0','1','1','2','3','4','4','5','6','6');
$dmg_rate_array[9]=array( '*','0','1','2','3','3','4','4','5','6','7');
$dmg_rate_array[10]=array('*','1','1','2','3','3','4','5','6','6','7');

$dmg_rate_array[11]=array('*','1','2','2','3','3','4','5','6','6','7');
$dmg_rate_array[12]=array('*','1','2','2','3','4','4','5','6','6','7');
$dmg_rate_array[13]=array('*','1','2','3','3','4','4','5','6','7','7');
$dmg_rate_array[14]=array('*','1','2','3','4','4','4','5','6','7','8');
$dmg_rate_array[15]=array('*','1','2','3','4','4','5','5','6','7','8');
$dmg_rate_array[16]=array('*','1','2','3','4','4','5','6','7','7','8');
$dmg_rate_array[17]=array('*','1','2','3','4','5','5','6','7','7','8');
$dmg_rate_array[18]=array('*','1','2','3','4','5','6','6','7','7','8');
$dmg_rate_array[19]=array('*','1','2','3','4','5','6','7','7','8','9');
$dmg_rate_array[20]=array('*','1','2','3','4','5','6','7','8','9','10');

$dmg_rate_array[21]=array('*','1','2','3','4','6','6','7','8','9','10');
$dmg_rate_array[22]=array('*','1','2','3','5','6','6','7','8','9','10');
$dmg_rate_array[23]=array('*','2','3','3','5','6','7','7','8','9','10');
$dmg_rate_array[24]=array('*','2','3','4','5','6','7','7','8','9','10');
$dmg_rate_array[25]=array('*','2','3','4','5','6','7','8','8','9','10');
$dmg_rate_array[26]=array('*','2','3','4','5','6','8','8','9','9','10');
$dmg_rate_array[27]=array('*','2','3','4','6','6','8','8','9','9','10');
$dmg_rate_array[28]=array('*','2','3','4','6','6','8','9','9','10','10');
$dmg_rate_array[29]=array('*','2','3','4','6','7','8','9','9','10','10');
$dmg_rate_array[30]=array('*','2','4','4','6','7','8','9','10','10','10');

$dmg_rate_array[31]=array('*','2','4','5','6','7','8','9','10','10','10');
$dmg_rate_array[32]=array('*','3','4','5','6','7','8','10','10','10','10');
$dmg_rate_array[33]=array('*','3','4','5','6','8','8','10','10','10','10');
$dmg_rate_array[34]=array('*','3','4','5','6','8','9','10','10','11','11');
$dmg_rate_array[35]=array('*','3','4','5','7','8','9','10','10','11','12');
$dmg_rate_array[36]=array('*','3','5','5','7','8','9','10','11','11','12');
$dmg_rate_array[37]=array('*','3','5','6','7','8','9','10','11','12','12');
$dmg_rate_array[38]=array('*','3','5','6','7','8','10','10','11','12','13');
$dmg_rate_array[39]=array('*','4','5','6','7','8','10','11','11','12','13');
$dmg_rate_array[40]=array('*','4','5','6','7','9','10','11','11','12','13');

$dmg_rate_array[41]=array('*','4','6','6','7','9','10','11','12','12','13');
$dmg_rate_array[42]=array('*','4','6','7','7','9','10','11','12','13','13');
$dmg_rate_array[43]=array('*','4','6','7','8','9','10','11','12','13','14');
$dmg_rate_array[44]=array('*','4','6','7','8','10','10','11','12','13','14');
$dmg_rate_array[45]=array('*','4','6','7','9','10','10','11','12','13','14');
$dmg_rate_array[46]=array('*','4','6','7','9','10','10','12','13','13','14');
$dmg_rate_array[47]=array('*','4','6','7','9','10','11','12','13','13','15');
$dmg_rate_array[48]=array('*','4','6','7','9','10','12','12','13','13','15');
$dmg_rate_array[49]=array('*','4','6','7','10','10','12','12','13','14','15');
$dmg_rate_array[50]=array('*','4','6','8','10','10','12','12','13','15','15');

$dmg_rate_array[51]=array('*','5','7','8','10','10','12','12','13','15','15');
$dmg_rate_array[52]=array('*','5','7','8','10','11','12','12','13','15','15');
$dmg_rate_array[53]=array('*','5','7','9','10','11','12','12','14','15','15');
$dmg_rate_array[54]=array('*','5','7','9','10','11','12','13','14','15','16');
$dmg_rate_array[55]=array('*','5','7','10','10','11','12','13','14','16','16');
$dmg_rate_array[56]=array('*','5','8','10','10','11','12','13','15','16','16');
$dmg_rate_array[57]=array('*','5','8','10','11','11','12','13','15','16','17');
$dmg_rate_array[58]=array('*','5','8','10','11','12','12','13','15','16','17');
$dmg_rate_array[59]=array('*','5','9','10','11','12','12','14','15','16','17');
$dmg_rate_array[60]=array('*','5','9','10','11','12','13','14','15','16','18');

$dmg_rate_array[61]=array('*','5','9','10','11','12','13','14','16','17','18');
$dmg_rate_array[62]=array('*','5','9','10','11','13','13','14','16','17','18');
$dmg_rate_array[63]=array('*','5','9','10','11','13','13','15','17','17','18');
$dmg_rate_array[64]=array('*','5','9','10','11','13','14','15','17','17','18');
$dmg_rate_array[65]=array('*','5','9','10','12','13','14','15','17','18','18');
$dmg_rate_array[66]=array('*','5','9','10','12','13','15','15','17','18','19');
$dmg_rate_array[67]=array('*','5','9','10','12','13','15','16','17','19','19');
$dmg_rate_array[68]=array('*','5','9','10','12','14','15','16','17','19','19');
$dmg_rate_array[69]=array('*','5','9','10','12','14','16','16','17','19','19');
$dmg_rate_array[70]=array('*','5','9','10','12','14','16','17','18','19','19');

$dmg_rate_array[71]=array('*','5','9','10','13','14','16','17','18','19','20');
$dmg_rate_array[72]=array('*','5','9','10','13','15','16','17','18','19','20');
$dmg_rate_array[73]=array('*','5','9','10','13','15','16','17','19','20','21');
$dmg_rate_array[74]=array('*','6','9','10','13','15','16','18','19','20','21');
$dmg_rate_array[75]=array('*','6','9','10','13','16','16','18','19','20','21');
$dmg_rate_array[76]=array('*','6','9','10','13','16','17','18','19','20','21');
$dmg_rate_array[77]=array('*','6','9','10','13','16','17','18','20','21','22');
$dmg_rate_array[78]=array('*','6','9','10','13','16','17','19','20','22','23');
$dmg_rate_array[79]=array('*','6','9','10','13','16','18','19','20','22','23');
$dmg_rate_array[80]=array('*','6','9','10','13','16','18','20','21','22','23');

$dmg_rate_array[81]=array('*','6','9','10','13','17','18','20','21','22','23');
$dmg_rate_array[82]=array('*','6','9','10','14','17','18','20','21','22','24');
$dmg_rate_array[83]=array('*','6','9','11','14','17','18','20','21','23','24');
$dmg_rate_array[84]=array('*','6','9','11','14','17','19','20','21','23','24');
$dmg_rate_array[85]=array('*','6','9','11','14','17','19','21','22','23','24');
$dmg_rate_array[86]=array('*','7','10','11','14','17','19','21','22','23','25');
$dmg_rate_array[87]=array('*','7','10','12','14','17','19','21','22','24','25');
$dmg_rate_array[88]=array('*','7','10','12','14','18','19','21','22','24','25');
$dmg_rate_array[89]=array('*','7','10','12','15','18','19','21','22','24','26');
$dmg_rate_array[90]=array('*','7','10','12','15','18','19','21','23','25','26');

$dmg_rate_array[91]=array('*','7','11','13','15','18','19','21','23','25','26');
$dmg_rate_array[92]=array('*','7','11','13','15','18','20','21','23','25','27');
$dmg_rate_array[93]=array('*','8','11','13','15','18','20','22','23','25','27');
$dmg_rate_array[94]=array('*','8','11','13','16','18','20','22','23','25','28');
$dmg_rate_array[95]=array('*','8','11','14','16','18','20','22','23','26','28');
$dmg_rate_array[96]=array('*','8','11','14','16','19','20','22','23','26','28');
$dmg_rate_array[97]=array('*','8','12','14','16','19','20','22','24','26','28');
$dmg_rate_array[98]=array('*','8','12','15','16','19','20','22','24','27','28');
$dmg_rate_array[99]=array('*','8','12','15','17','19','20','22','24','27','29');
$dmg_rate_array[100]=array('*','8','12','15','18','19','20','22','24','27','30');

if(preg_match('/^k([0-9]+?)([\-+]{1,2})([0-9]+?)@([0-9]+)$/i',$chipcommand,$match)){
    $rollcommand=2;
    $dmg_rate=(int)$match[1];
    $count_number=2;
    $dice_surface=6;
    if(((string)$match[2]=='+')||((string)$match[2]=='++')||((string)$match[2]=='--')){
        $plus_number=(int)$match[3];
    }else{
        $plus_number=-(int)$match[3];
    }
    $critical_rate=(int)$match[4];
    $special_method=true;
}elseif(preg_match('/^k([0-9]+?)@([0-9]+)$/i',$chipcommand,$match)){
    $rollcommand=2;
    $dmg_rate=(int)$match[1];
    $count_number=2;
    $dice_surface=6;
    $plus_number=false;
    $critical_rate=(int)$match[2];
    $special_method=true;
}elseif(preg_match('/^k([0-9]+?)([\-+]{1,2})([0-9]+)$/i',$chipcommand,$match)){
    $rollcommand=2;
    $dmg_rate=(int)$match[1];
    $count_number=2;
    $dice_surface=6;
    if(((string)$match[2]=='+')||((string)$match[2]=='++')||((string)$match[2]=='--')){
        $plus_number=(int)$match[3];
    }else{
        $plus_number=-(int)$match[3];
    }
    $critical_rate=13;
    $special_method=true;
}elseif(preg_match('/^k([0-9]+)$/i',$chipcommand,$match)){
    $rollcommand=2;
    $dmg_rate=(int)$match[1];
    $count_number=2;
    $dice_surface=6;
    $plus_number=false;
    $critical_rate=13;
    $special_method=true;
}
if($rollcommand!=0){
    $roll_first_comment=$call_name.'さんの'.$chipcomment.'ロール('.$typecommand.') → ';
    $dammy_dice=array();
    $comment='';
    // ロール処理
    if($result_comment!='エラー'){
        $dice_result=0;
        $count_loop=0;
        do{
            $result_detail_comment='';
            $result_comment='';
            $total_roll=0;
            $auto_failure=false;
            $dice=array();
            $roll_count=0;
            $temp_dice=array();
            if($critical_rate<3){
                $result_comment='エラー';
                $command_error_mes='(C値は3～12で設定してください)';
            }elseif(!empty($dmg_rate_array[$dmg_rate][0])){
                while(1){
                    $roll_count++;
                    $decision_roll=rollDice($count_number,$dice_surface,$dice,DICE_ROLL_LIMIT,DICE_SURFACE_LIMIT);
                    $temp_dice[]=$dice[0];
                    $temp_dice[]=$dice[1];
                    if($decision_roll==2){
                        break;
                    }elseif($decision_roll<$critical_rate){
                        $total_roll=$total_roll+$dmg_rate_array[$dmg_rate][($decision_roll-2)];
                        break;
                    }else{
                        $total_roll=$total_roll+$dmg_rate_array[$dmg_rate][($decision_roll-2)];
                    }
                }
                if(($roll_count==1)&&($decision_roll==2)){
                    $auto_failure=true;
                }
                $i=0;
                foreach($temp_dice as $value){
                    if($i!=0){
                        $result_detail_comment.=',';
                    }
                    $result_detail_comment.=$value[1];
                    $dammy_dice[]=$value;
                    $i++;
                }
                if($plus_number!==false){
                    $total_roll=$total_roll+$plus_number;
                }
                $dice_roll_flag=true;
            }else{
                $result_comment='エラー';
                $command_error_mes='(威力値は0～100で設定してください)';
            }
            // 判定結果の決定　 1:>= 2:<= 3:<> 4:> 5:< 6:=
            if($result_comment=='エラー'){
                // なにもしない
            }elseif($auto_failure==true){
                $result_comment='自動失敗 ';
            }else{
                $result_comment=$total_roll;
            }
            // コメント作成
            /*
            if($count_loop>0){
                $comment.='、';
            }*/
            if($repeat_flag!=0){
                $comment.='<br>→ '.($count_loop+1).'回目：';
            }
            $comment.=$result_comment.$command_error_mes;
            if(!empty($result_detail_comment)){
                $comment.=' ('.$result_detail_comment.')';
            }
            // ループ関係処理
            if($count_loop==0){
                $dice_result=abs($total_roll);
            }
            $count_loop++;
            if($result_comment==='エラー'){
                break;
            }
        }while($count_loop<$repeat_flag);
    }else{
        $comment.=$result_comment.$command_error_mes;
    }
    // コメント完成
    $comment=$roll_first_comment.$comment;
    $dice=array();
    $dammy_dice_count=0;
    foreach($dammy_dice as $dd_value){
        $dice[$dammy_dice_count]=$dd_value;
        $dammy_dice_count++;
    }
    $system_comment_flag=true;
}